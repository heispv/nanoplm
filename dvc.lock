schema: '2.0'
stages:
  download:
    cmd: myplm data download --url 
      https://ftp.uniprot.org/pub/databases/uniprot/knowledgebase/complete/uniprot_sprot.fasta.gz
      -o output/data/raw/uniref50.fasta.gz
    deps:
    - path: src/myplm/data/downloader.py
      hash: md5
      md5: 02d71a6c8dd1ef8a1147684b606b1e0f
      size: 2308
    params:
      params.yaml:
        data_dirs.compressed_fasta: output/data/raw/uniref50.fasta.gz
        data_dirs.url: 
          https://ftp.uniprot.org/pub/databases/uniprot/knowledgebase/complete/uniprot_sprot.fasta.gz
    outs:
    - path: output/data/raw/uniref50.fasta.gz
      hash: md5
      md5: 54e5460f7950fe1a66df187ca9dda1df
      size: 93100075
  extract:
    cmd: myplm data extract -i output/data/raw/uniref50.fasta.gz -o 
      output/data/raw/uniref50.fasta
    deps:
    - path: output/data/raw/uniref50.fasta.gz
      hash: md5
      md5: 54e5460f7950fe1a66df187ca9dda1df
      size: 93100075
    - path: src/myplm/data/extractor.py
      hash: md5
      md5: 512cd3f6de000113a4d89834b948ad33
      size: 1398
    params:
      params.yaml:
        data_dirs.compressed_fasta: output/data/raw/uniref50.fasta.gz
        data_dirs.extracted_fasta: output/data/raw/uniref50.fasta
    outs:
    - path: output/data/raw/uniref50.fasta
      hash: md5
      md5: e535ce25d0bf7967d3a18c6e6a7f3f38
      size: 286776098
  preprocess:
    cmd: python3 main.py --preprocess-data
    deps:
    - path: pipeline_output/data/raw/uniref50.fasta
      hash: md5
      md5: acd7214694350f9a0c097122b777c978
      size: 286365155
    - path: src/data/preprocess.py
      hash: md5
      md5: 69e0e61bee2114bbe3a0b837c636499a
      size: 6703
    params:
      src/data/params.yaml:
        max_seqs_number: 202
        max_sequence_length: 512
        min_sequence_length: 20
    outs:
    - path: pipeline_output/data/processed/uniref50_processed.fasta
      hash: md5
      md5: 7099fbb631785692da131ae0a98ed059
      size: 60788
  split:
    cmd: myplm data split -i output/data/filter/uniref50_filtered.fasta -o 
      output/data/split --val-ratio 0.1
    deps:
    - path: output/data/filter/uniref50_filtered.fasta
      hash: md5
      md5: c5817e3e2541de66ed12d0c2f5b1e0d1
      size: 38422
    - path: src/myplm/data/splitor.py
      hash: md5
      md5: a6c271c9f2c439f386d074e0c2aa93d9
      size: 1584
    params:
      params.yaml:
        data_dirs.filtered_fasta: output/data/filter/uniref50_filtered.fasta
        data_dirs.splitted_fasta_dir: output/data/split
        data_params.val_ratio: 0.1
    outs:
    - path: output/data/split
      hash: md5
      md5: 00814df350aac3d25bcf53cd53e9bdf2.dir
      size: 38422
      nfiles: 2
  tokenize:
    cmd: python3 main.py --tokenize-data
    deps:
    - path: pipeline_output/data/processed/train.fasta
      hash: md5
      md5: d3114b24a98457eb269891fcc474e843
      size: 14609
    - path: pipeline_output/data/processed/val.fasta
      hash: md5
      md5: a5ab862149ad0d734db991a819c47843
      size: 1295
    - path: src/protx/data/preprocess.py
      hash: md5
      md5: d3ece3f667f2a2dd0f968dd2635902a0
      size: 10479
    params:
      src/protx/data/params.yaml:
        batch_size: 32
    outs:
    - path: pipeline_output/data/processed/tokenized/train.h5
      hash: md5
      md5: 67a588690f8650512f79b23a83f91714
      size: 382880
    - path: pipeline_output/data/processed/tokenized/val.h5
      hash: md5
      md5: 23d6698d8961b260cffefbfc2451dee0
      size: 32192
  filter:
    cmd: myplm data filter -i output/data/raw/uniref50_shuffled.fasta -o 
      output/data/filter/uniref50_filtered.fasta --min-seq-len 20 --max-seq-len 
      512 --seqs-num 100 --skip-n 0
    deps:
    - path: output/data/raw/uniref50_shuffled.fasta
      hash: md5
      md5: 881ddcb151c839c672608181f9f021a0
      size: 286776098
    - path: src/myplm/data/filterer.py
      hash: md5
      md5: 6f2d3b909ebae82c37a54617b613e69e
      size: 2704
    params:
      params.yaml:
        data_dirs.shuffled_fasta: output/data/raw/uniref50_shuffled.fasta
        data_params.filter_skip_n: 0
        data_params.max_seq_len: 512
        data_params.min_seq_len: 20
        data_params.seqs_num: 100
    outs:
    - path: output/data/filter/uniref50_filtered.fasta
      hash: md5
      md5: c5817e3e2541de66ed12d0c2f5b1e0d1
      size: 38422
  teacher_embeddings:
    cmd: python3 main.py --generate-teacher-embeddings
    deps:
    - path: pipeline_output/data/processed/tokenized/train.h5
      hash: md5
      md5: 67a588690f8650512f79b23a83f91714
      size: 382880
    - path: pipeline_output/data/processed/tokenized/val.h5
      hash: md5
      md5: 23d6698d8961b260cffefbfc2451dee0
      size: 32192
    - path: src/protx/distillation/teacher_embed.py
      hash: md5
      md5: ec563bebe157f4886fe7980706e029af
      size: 6671
    - path: src/protx/models/teacher.py
      hash: md5
      md5: d5ff4110db6d1501f3deb215382fd642
      size: 3949
    params:
      src/protx/data/params.yaml:
        batch_size: 32
    outs:
    - path: pipeline_output/data/processed/teacher_embeddings/train.h5
      hash: md5
      md5: 46c6b4d473a42a4753c03bc5027954f4
      size: 89796608
    - path: pipeline_output/data/processed/teacher_embeddings/val.h5
      hash: md5
      md5: e6578f11952e091cc28b89d65d757fd0
      size: 6111312
  filter_split:
    cmd: python3 main.py --filter-split-data
    deps:
    - path: output/data/raw/uniref50.fasta
      hash: md5
      md5: 7648cf32219f4e5f20aebc514817120d
      size: 286510912
    - path: src/protx/data/filter_splitor.py
      hash: md5
      md5: 62d1668cf8e6c151809572dddeb8c20a
      size: 5424
    params:
      src/protx/data/params.yaml:
        max_seq_len: 512
        max_seqs_num: 50
        min_seq_len: 20
        val_ratio: 0.1
    outs:
    - path: output/data/filter_split/dataset_info.txt
      hash: md5
      md5: a32f631b6afb42a857ee51cdaf85ee38
      size: 262
    - path: output/data/filter_split/train.fasta
      hash: md5
      md5: 77f1e737d76f3596305a5b4e2935b7b2
      size: 14719
    - path: output/data/filter_split/uniref50_filtered.fasta
      hash: md5
      md5: 7488763186eb49222e622344670a3b69
      size: 15904
    - path: output/data/filter_split/val.fasta
      hash: md5
      md5: 4d3f1c8de4576a0c25d1293fc2a45b73
      size: 1185
  shuffle:
    cmd: myplm data shuffle -i output/data/raw/uniref50.fasta -o 
      output/data/raw/uniref50_shuffled.fasta --seed 24
    deps:
    - path: output/data/raw/uniref50.fasta
      hash: md5
      md5: e535ce25d0bf7967d3a18c6e6a7f3f38
      size: 286776098
    - path: src/myplm/data/shuffler.py
      hash: md5
      md5: b208a57a9b09e387960a00faa121bfcc
      size: 4113
    params:
      params.yaml:
        data_dirs.shuffled_fasta: output/data/raw/uniref50_shuffled.fasta
        data_params.shuffle_seed: 24
    outs:
    - path: output/data/raw/uniref50_shuffled.fasta
      hash: md5
      md5: 881ddcb151c839c672608181f9f021a0
      size: 286776098
  save_kd_train_dataset:
    cmd: myplm data save-kd-dataset -i output/data/split/train.fasta -o 
      output/data/kd_dataset/train --teacher-model prott5 --max-seq-len 512 
      --n-files 5 --batch-size 2 --device auto --skip-n 0
    deps:
    - path: output/data/split/train.fasta
      hash: md5
      md5: e0cf11a687fce31f878e2741dc9fba1f
      size: 35098
    - path: src/myplm/data/dataset.py
      hash: md5
      md5: 0a2434193b6c6cfcbcf827dcd4b16378
      size: 33493
    params:
      params.yaml:
        data_dirs.kd_train_dir: output/data/kd_dataset/train
        data_dirs.splitted_fasta_dir: output/data/split
        data_params.embed_calc_batch_size: 2
        data_params.filter_skip_n: 0
        data_params.max_seq_len: 512
        data_params.train_shards: 5
    outs:
    - path: output/data/kd_dataset/train
      hash: md5
      md5: 4f16f3e8711cbf6031183a5d40dd9ff1.dir
      size: 94650240
      nfiles: 5
  save_kd_val_dataset:
    cmd: myplm data save-kd-dataset -i output/data/split/val.fasta -o 
      output/data/kd_dataset/val --teacher-model prott5 --max-seq-len 512 
      --n-files 2 --batch-size 2 --device auto --skip-n 0
    deps:
    - path: output/data/split/val.fasta
      hash: md5
      md5: 10d6cc4f6a43f613a0ad75c80c8b2038
      size: 3324
    - path: src/myplm/data/dataset.py
      hash: md5
      md5: 0a2434193b6c6cfcbcf827dcd4b16378
      size: 33493
    params:
      params.yaml:
        data_dirs.kd_val_dir: output/data/kd_dataset/val
        data_dirs.splitted_fasta_dir: output/data/split
        data_params.embed_calc_batch_size: 2
        data_params.filter_skip_n: 0
        data_params.max_seq_len: 512
        data_params.val_shards: 2
    outs:
    - path: output/data/kd_dataset/val
      hash: md5
      md5: 21e8af826cc46dc0492723a104a35b8c.dir
      size: 10519296
      nfiles: 2
